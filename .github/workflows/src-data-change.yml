name: âˆ† src-data
description: Sync JSON and @context changes from src-data to production, applying relevant updates.
permissions:
  contents: write
  pages: write
  actions: write
  id-token: write
on:
  push:
    branches:
      - "src-data"
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug output'
        required: false
        default: 'false'
        type: boolean
jobs:
  sync_to_production:
    runs-on: ubuntu-latest
    steps:
          
      - name: Checkout production branch
        uses: actions/checkout@v4
        with:
          ref: production
          fetch-depth: 0
          persist-credentials: true

      - name: Clean production except docs and summaries
        run: |
          shopt -s extglob dotglob
          rm -rf -- !(docs|summaries|.git|.github) || true

      - name: Restore path from src-data branch
        uses: WCRP-CMIP/CMIPLD/actions/fetch_branch_path@main
        with:
          branch: "src-data"
          path: .
          remove: false

      - name: Verify restore and prepare changes
        run: |
          git fetch origin src-data
          git add -A

      - name: Check for changes
        id: check_changes
        run: |
          git config user.name "cmip-ipo"
          git config user.email "actions@wcrp-cmip.org"
          
          git reset HEAD -- . || true
          git add -A
          
          if git diff --cached --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            if ! git diff --quiet HEAD origin/src-data; then
              git checkout origin/src-data -- . || true
              git add -A
              if ! git diff --cached --quiet; then
                echo "no_changes=false" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push Changes
        if: steps.check_changes.outputs.no_changes == 'false'
        uses: EndBug/add-and-commit@v9
        with:
          add: '.'
          author_name: 'cmip-ipo'
          author_email: 'actions@wcrp-cmip.org'
          message: 'Clean file upload from src-data'
          branch: production
          push: true
          
  graph:
    uses: WCRP-CMIP/CMIPLD/.github/workflows/graph.yml@main
    needs: sync_to_production
    with:
      updated: false
    
  publish-pages:
    if: always()
    needs:
      - graph
    uses: WCRP-CMIP/CMIPLD/.github/workflows/pages.yml@main
    with:
      branch: production
      force: true
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}

  generate-summaries:
    uses: WCRP-CMIP/CMIPLD/.github/workflows/summarise.yml@main
    with:
      output-path: './content_summaries/'